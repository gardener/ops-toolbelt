#!/bin/bash -e

# SPDX-FileCopyrightText: 2025 SAP SE or an SAP affiliate company and Gardener contributors
#
# SPDX-License-Identifier: Apache-2.0


function show_help () {
  echo "Usage: ${0} [arguments]"
  echo "Possible arguments:"
  echo "-h, --help       Show this help message and exit"
}


function install () {
  etcd_benchmark_version="v0.1.0"
  local version="${1:-${etcd_benchmark_version}}"
  local download_url
  local yellow="\033[0;33m"
  local nc="\033[0m"
  local arch
  local platform
  local dest
  local tmp_dir
  local pkg

  tmp_dir="$(mktemp -d)"
  mkdir -p "${tmp_dir}/dest"

  dest="/opt/bin/benchmark"

  if uname="$(whoami 2> /dev/null)"; then
    if [[ "${uname}" == "root" ]]; then
      if [ -w "/usr/local/bin" ]; then
        dest="/usr/local/bin/benchmark"
      fi
    fi
  fi

  arch=$(uname -m | sed 's/^x86_64$/amd64/;s/^aarch64$/arm64/')
  platform="$(uname -s | tr '[:upper:]' '[:lower:]')"

  pkg="benchmark-${version}-${platform}-${arch}"

  download_url="https://github.com/ishan16696/etcd-backup-restore/releases/download/${version}/${pkg}.tar.gz"

  curl -sL "${download_url}" \
    -o "${tmp_dir}/${pkg}.tar.gz" && \
    tar -zxf "${tmp_dir}/${pkg}.tar.gz" -C "${tmp_dir}/dest" && \
    mv "${tmp_dir}/dest/benchmark" "${dest}" && \
    chmod 755 "${dest}" && \
    rm -rf "${tmp_dir}"

  echo -e "${yellow}"
  echo "You can now start using etcd benchmark tool. Just execute \"benchmark\" to use it. For more details: https://github.com/etcd-io/etcd/blob/main/tools/benchmark/README.md"
  echo -e "${nc}"
}

case "$1" in
  --help | -h)
    show_help
    exit
    ;;
  *)
    install
    exit
    ;;
esac